<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NJ Respiratory Policy Portal</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Mammoth.js (Reads Word Docs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Firebase Connection -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        // --- LIVE DATABASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAefsgDE8YT1MLwC0wTEsFB799vKbStgyk",
            authDomain: "njra-policies.firebaseapp.com",
            projectId: "njra-policies",
            storageBucket: "njra-policies.firebasestorage.app",
            messagingSenderId: "779465511706",
            appId: "1:779465511706:web:d3fb672bcc89f168d892a3",
            measurementId: "G-2046SMFN0T"
        };
        
        window.isDemoMode = false;

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            // Expose services
            window.collection = collection;
            window.addDoc = addDoc;
            window.getDocs = getDocs;
            window.updateDoc = updateDoc;
            window.deleteDoc = deleteDoc;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.doc = doc;
            window.onSnapshot = onSnapshot;
            window.query = query;
            window.orderBy = orderBy;
            window.where = where;
            window.signInAnonymously = signInAnonymously;
            
            console.log("Firebase Connected");
        } catch (e) {
            console.error("Firebase Init Error:", e);
            window.isDemoMode = true; 
        }
    </script>

    <script>
        // --- EMAILJS CONFIGURATION ---
        // REPLACE THESE WITH YOUR ACTUAL KEYS
        const EMAILJS_SERVICE_ID = "service_e8rbn3f";   
        const EMAILJS_TEMPLATE_ID = "template_tnqja7a"; 
        const EMAILJS_PUBLIC_KEY = "I-fs7ljzMeCgNUEGJ"; 

        (function(){
            try {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            } catch(e) {
                console.warn("EmailJS failed to init:", e);
            }
        })();

        tailwind.config = {
            corePlugins: { preflight: false }, 
            theme: {
                extend: {
                    colors: {
                        njra: { 
                            50: '#fdf2f2',
                            100: '#fde8e8',
                            500: '#af3030',  // PRIMARY RED
                            600: '#942626',
                            900: '#444444'   // SECONDARY GRAY
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap');
        
        /* --- CORE APP CONTAINER --- */
        #njra-app-root {
            font-family: 'Lato', sans-serif;
            background-color: #f8fafc;
            color: #444444;
            line-height: 1.5;
            box-sizing: border-box;
            width: 100%;
            display: block;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #njra-app-root *, #njra-app-root *::before, #njra-app-root *::after { box-sizing: inherit; }

        /* --- BUTTON OVERRIDES --- */
        .njra-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            text-decoration: none;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .njra-btn-primary {
            background-color: #af3030 !important; /* RED */
            color: #ffffff !important;
        }
        .njra-btn-primary:hover {
            background-color: #942626 !important;
        }
        .njra-btn-primary:disabled {
            background-color: #fca5a5 !important;
            cursor: not-allowed;
        }

        .njra-btn-secondary {
            background-color: #444444 !important; /* DARK GRAY */
            color: #ffffff !important;
        }
        .njra-btn-secondary:hover {
            background-color: #000000 !important;
        }

        .njra-btn-success {
            background-color: #10b981 !important; /* GREEN */
            color: #ffffff !important;
        }
        .njra-btn-success:disabled {
            background-color: #10b981 !important;
            opacity: 0.8;
            cursor: default;
        }

        .njra-btn-outline {
            background-color: #e2e8f0 !important; /* LIGHT GRAY */
            color: #444444 !important;
            border: 1px solid #94a3b8 !important;
        }
        .njra-btn-outline:hover {
            background-color: #cbd5e1 !important;
        }

        /* --- TYPOGRAPHY RESETS --- */
        #njra-app-root h1 { font-size: 2em; font-weight: 700; margin-bottom: 0.5em; line-height: 1.2; margin-top: 0; color: #af3030; }
        #njra-app-root h2 { font-size: 1.5em; font-weight: 600; margin-bottom: 0.5em; line-height: 1.3; margin-top: 1em; color: #444444; }
        #njra-app-root h3 { font-size: 1.17em; font-weight: 600; margin-bottom: 0.5em; color: #444444; }
        #njra-app-root p { margin-bottom: 1em; margin-top: 0; }
        #njra-app-root ul, #njra-app-root ol { margin-bottom: 1em; padding-left: 1.5em; margin-top: 0; }
        #njra-app-root ul { list-style-type: disc; }
        #njra-app-root ol { list-style-type: decimal; }
        #njra-app-root input, #njra-app-root textarea { color: #333; }
        
        .policy-content h1 { color: #af3030; border-bottom: 2px solid #fbd5d5; padding-bottom: 0.2em; margin-top: 1.5em; }
        .policy-content h2 { color: #444444; margin-top: 1.5em; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
        .policy-content strong { font-weight: 700; color: #222; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            #njra-app-root { border: none; width: 100% !important; margin: 0 !important; }
            .quiz-question-block { page-break-inside: avoid; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .print-page-break { page-break-before: always; }
            .print-cover-page { 
                height: 100vh; 
                display: flex; 
                flex-direction: column; 
                justify-content: center; 
                align-items: center; 
                text-align: center;
                page-break-after: always;
            }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="njra-app-root">
        <div style="padding: 60px; text-align: center; color: #af3030;">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i>
            <p style="margin-top: 15px; color: #444; font-weight: bold;">Loading NJRA Portal...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CATEGORIES = [
            "Emergency Procedures", "Clinical Care", "Equipment Management",
            "Patient Assessment", "Infection Control", "Documentation",
            "Administrative", "Uncategorized"
        ];

        // --- JSON CLEANER HELPER ---
        // This fixes the "failed to save" issue by stripping Markdown wrappers
        const cleanAndParseJSON = (text) => {
            let cleanText = text.trim();
            // Remove markdown code blocks if present
            if (cleanText.startsWith("```json")) {
                cleanText = cleanText.replace(/^```json/, "").replace(/```$/, "");
            } else if (cleanText.startsWith("```")) {
                cleanText = cleanText.replace(/^```/, "").replace(/```$/, "");
            }
            return JSON.parse(cleanText);
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [policies, setPolicies] = useState([]);
            const [selectedPolicy, setSelectedPolicy] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [adminPass, setAdminPass] = useState("");
            const [status, setStatus] = useState("Connecting...");
            const [selectedForPrint, setSelectedForPrint] = useState(new Set()); 
            const [lastUpdated, setLastUpdated] = useState("Loading...");
            
            // AI
            const [apiKey, setApiKey] = useState(localStorage.getItem('njra_openai_key') || "");
            const [isProcessing, setIsProcessing] = useState(false);
            const [uploadQueue, setUploadQueue] = useState([]); 
            const [newPolicyTopic, setNewPolicyTopic] = useState("");

            useEffect(() => {
                setLastUpdated(new Date().toLocaleString());
                const init = async () => {
                    setTimeout(() => { if(status === "Connecting...") setStatus("Connecting..."); }, 2000);
                    try {
                        if (window.auth && window.db) {
                            await window.signInAnonymously(window.auth);
                            const q = window.query(window.collection(window.db, 'policies'), window.orderBy('title'));
                            window.onSnapshot(q, (snapshot) => {
                                const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                setPolicies(loaded);
                                setStatus(""); 
                            }, (error) => { console.error("DB Error:", error); setStatus("Error: " + error.message); });
                            
                            // Fetch Last Updated Timestamp
                            const metaRef = window.doc(window.db, 'metadata', 'system');
                            window.onSnapshot(metaRef, (doc) => {
                                if(doc.exists()) setLastUpdated(doc.data().lastUpdated);
                                else setLastUpdated("N/A");
                            });
                        } else { setStatus("System initializing..."); }
                    } catch (e) { console.error("Init Error:", e); setStatus("Connection Error: " + e.message); }
                };
                
                const params = new URLSearchParams(window.location.search);
                const codeParam = params.get('code');
                init();
            }, []);

            // --- UTILS ---
            const updateSystemTimestamp = async () => {
                const now = new Date().toLocaleString();
                await window.setDoc(window.doc(window.db, 'metadata', 'system'), { lastUpdated: now });
            };

            const togglePrintSelection = (policyId) => {
                const newSet = new Set(selectedForPrint);
                if (newSet.has(policyId)) newSet.delete(policyId);
                else newSet.add(policyId);
                setSelectedForPrint(newSet);
            };

            const handleBatchPrint = () => {
                setView('batch_print');
            };

            // --- AI & IMPORT LOGIC ---
            const handleApiKeyChange = (e) => {
                const key = e.target.value.trim();
                setApiKey(key);
                localStorage.setItem('njra_openai_key', key);
            };
            const resetApiKey = () => {
                setApiKey("");
                localStorage.removeItem('njra_openai_key');
                alert("API Key cleared.");
            };

            const testOpenAIConnection = async () => {
                if (!apiKey) { alert("Please enter a key first."); return; }
                setStatus("Testing Connection...");
                try {
                    const response = await fetch("https://api.openai.com/v1/models", {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${apiKey}` }
                    });
                    if (response.ok) {
                        alert("Connection Successful! Your API Key is valid.");
                    } else {
                        const err = await response.json();
                        alert("Connection Failed: " + (err.error?.message || response.statusText));
                    }
                } catch (e) {
                    alert("Network Error (Failed to Fetch). Check your internet or firewall.");
                }
                setStatus("");
            };

            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setUploadQueue(prev => [...prev, ...files]);
            };
            const removeFile = (idx) => { setUploadQueue(prev => prev.filter((_, i) => i !== idx)); };
            
            // Common AI Call Function
            const callAI = async (prompt) => {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], response_format: { type: "json_object" } })
                });
                if (!response.ok) { const errData = await response.json(); throw new Error(`OpenAI Error: ${errData.error?.message || response.statusText}`); }
                return await response.json();
            };

            const saveBatchToDB = async (items) => {
                setStatus("Saving to Database...");
                let addedCount = 0;
                let updatedCount = 0;
                
                for(let item of items) {
                    try {
                        let exists = false;
                        let existingId = null;
                        
                        // Basic Validation
                        if (!item.title || !item.content) {
                            console.error("Skipping invalid item:", item);
                            continue; 
                        }

                        if (item.code) {
                            const q = window.query(window.collection(window.db, 'policies'), window.where('code', '==', item.code));
                            const snapshot = await window.getDocs(q);
                            if (!snapshot.empty) { exists = true; existingId = snapshot.docs[0].id; }
                        }
                        
                        if (exists) { 
                            await window.updateDoc(window.doc(window.db, 'policies', existingId), item); 
                            updatedCount++; 
                        } else { 
                            await window.addDoc(window.collection(window.db, 'policies'), item); 
                            addedCount++; 
                        }
                    } catch (dbErr) {
                        console.error("DB Save Error for " + item.title, dbErr);
                        alert("Failed to save policy: " + item.title + "\nError: " + dbErr.message);
                    }
                }
                
                if (addedCount > 0 || updatedCount > 0) {
                    await updateSystemTimestamp();
                    alert(`Success!\nAdded: ${addedCount}\nUpdated: ${updatedCount}`);
                } else {
                    alert("No valid policies were generated to save. Check API response.");
                }
                
                setStatus("");
                setIsProcessing(false);
            };

            const processQueue = async () => {
                if (!apiKey) { alert("Please enter an OpenAI API Key first."); return; }
                if (uploadQueue.length === 0) return;
                setIsProcessing(true);
                let combinedJson = [];

                for (let i = 0; i < uploadQueue.length; i++) {
                    const file = uploadQueue[i];
                    setStatus(`Processing ${i+1}/${uploadQueue.length}: ${file.name}...`);
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                        const rawText = result.value;
                        const prompt = `
                            You are a medical policy assistant. Return a VALID JSON object for a respiratory therapy policy.
                            CRITICAL: If a code (e.g. RT-00X) is not explicitly found, GENERATE A UNIQUE ONE based on the title initials.
                            
                            Structure:
                            {
                                "title": "Extract Title",
                                "code": "Extract Code OR Generate Unique Code",
                                "category": "Pick best fit: 'Emergency Procedures', 'Clinical Care', 'Equipment Management', 'Patient Assessment', 'Infection Control', 'Documentation', or 'Administrative'",
                                "content": "The full policy text formatted as clean HTML (use <h2>, <p>, <ul>, <li>, <strong>). Correct grammar and spelling.",
                                "questions": [
                                    { "text": "Question text", "options": ["A", "B", "C", "D"], "correctIndex": 0 },
                                    { ... Ensure exactly 5 questions ... }
                                ]
                            }
                            Here is the raw text: ${rawText}
                        `;
                        const data = await callAI(prompt);
                        // USE CLEANER HERE
                        let content = cleanAndParseJSON(data.choices[0].message.content);
                        
                        // Handle AI wrapper variations
                        let items = [];
                        if (content.policies) items = content.policies;
                        else if (Array.isArray(content)) items = content;
                        else items = [content];

                        combinedJson.push(...items);

                    } catch (err) { 
                        console.error(err); 
                        alert(`Error processing ${file.name}: ${err.message}`); 
                    }
                }
                
                // AUTOMATICALLY SAVE TO DATABASE
                if(combinedJson.length > 0) {
                    await saveBatchToDB(combinedJson);
                } else {
                    alert("AI processing returned no data. Check your files.");
                    setIsProcessing(false);
                    setStatus("");
                }
                setUploadQueue([]); 
            };

            const createFromTopic = async () => {
                if (!apiKey) { alert("Please enter an OpenAI API Key first."); return; }
                if (!newPolicyTopic) return;
                setIsProcessing(true);
                setStatus(`Generating policy for: ${newPolicyTopic}...`);
                
                try {
                    const prompt = `
                        Write a comprehensive respiratory therapy policy for the topic: "${newPolicyTopic}".
                        Return a VALID JSON object.
                        Structure:
                        {
                            "title": "Formal Policy Title",
                            "code": "Generate a unique code (e.g. RT-XXX)",
                            "category": "Pick best fit from standard medical categories",
                            "content": "The full policy text formatted as clean HTML (use <h2>, <p>, <ul>, <li>, <strong>). Include Purpose, Scope, Procedure, and References.",
                            "questions": [
                                { "text": "Question text", "options": ["A", "B", "C", "D"], "correctIndex": 0 },
                                { ... Create exactly 5 competency questions ... }
                            ]
                        }
                    `;
                    const data = await callAI(prompt);
                    // USE CLEANER HERE
                    const content = cleanAndParseJSON(data.choices[0].message.content);
                    const items = Array.isArray(content) ? content : [content];
                    
                    // AUTOMATICALLY SAVE
                    await saveBatchToDB(items);
                    setNewPolicyTopic("");
                } catch (err) { 
                    console.error(err); 
                    alert(`Generation Error: ${err.message}`); 
                    setIsProcessing(false);
                    setStatus("");
                }
            };

            const updateDbCategory = async (id, newCat) => { try { await window.updateDoc(window.doc(window.db, 'policies', id), { category: newCat }); await updateSystemTimestamp(); } catch(e) { alert("Update failed: " + e.message); } };
            
            const handleDelete = async (id) => {
                if(!confirm("Delete this policy permanently?")) return;
                try { await window.deleteDoc(window.doc(window.db, 'policies', id)); await updateSystemTimestamp(); } 
                catch(e) { alert("Delete failed: " + e.message); }
            };

            // --- COMPONENTS ---

            const PolicyList = ({ policies, onSelectPolicy, onTakeQuiz }) => {
                const [searchTerm, setSearchTerm] = useState("");
                const [viewMode, setViewMode] = useState('list'); 

                const groupedPolicies = policies.reduce((acc, policy) => {
                    const cat = policy.category || "Uncategorized";
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(policy);
                    return acc;
                }, {});

                const filteredPolicies = policies.filter(p => 
                    p.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (p.code && p.code.toLowerCase().includes(searchTerm.toLowerCase()))
                );

                const showGrouped = searchTerm === "";

                return (
                    <div className="w-full">
                        {/* Search Hero */}
                        <div className="text-center mb-8 bg-white p-8 rounded-lg shadow-sm border border-gray-200">
                            <h1 className="text-3xl font-bold text-njra-500 mb-2">Policy Database</h1>
                            <p className="text-gray-500 mb-6">Search respiratory therapy protocols and competencies.</p>
                            <div className="max-w-xl mx-auto relative">
                                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400"><i className="fas fa-search text-lg"></i></div>
                                <input type="text" className="block w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-full leading-5 bg-gray-50 placeholder-gray-400 focus:outline-none focus:border-njra-500 focus:ring-1 focus:ring-njra-500 transition-all text-base shadow-sm" placeholder="Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="flex justify-between items-center mb-4 px-1 sticky top-16 z-30 bg-[#f8fafc] py-2">
                            <h2 className="text-lg font-bold text-gray-700 flex items-center">
                                {selectedForPrint.size > 0 ? (
                                    <button onClick={handleBatchPrint} className="njra-btn njra-btn-primary animate-bounce">
                                        <i className="fas fa-print mr-2"></i> Print ({selectedForPrint.size}) Selected
                                    </button>
                                ) : (
                                    <span>Table of Contents</span>
                                )}
                            </h2>
                            <div className="flex bg-white p-1 rounded-md border border-gray-300 shadow-sm">
                                <button onClick={() => setViewMode('list')} className={`px-3 py-1 rounded text-sm font-medium flex items-center transition-all ${viewMode === 'list' ? 'bg-njra-50 text-njra-500' : 'text-gray-400 hover:text-gray-600'}`}><i className="fas fa-list"></i></button>
                                <button onClick={() => setViewMode('grid')} className={`px-3 py-1 rounded text-sm font-medium flex items-center transition-all ${viewMode === 'grid' ? 'bg-njra-50 text-njra-500' : 'text-gray-400 hover:text-gray-600'}`}><i className="fas fa-th-large"></i></button>
                            </div>
                        </div>

                        {/* List Content */}
                        {showGrouped ? (
                            Object.keys(groupedPolicies).sort().map(cat => (
                                <div key={cat} className="mb-8">
                                    <h3 className="text-xl font-bold text-njra-900 mb-3 border-b border-gray-200 pb-1">{cat}</h3>
                                    <div className="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50"><tr><th className="w-12 px-6 py-3"></th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-24">Code</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Policy Title</th><th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider w-48">Actions</th></tr></thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {groupedPolicies[cat].map((policy, idx) => (
                                                    <tr key={policy.id} className={`transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'} hover:bg-njra-50`}>
                                                        <td className="px-6 py-4 text-center">
                                                            <input type="checkbox" className="w-4 h-4 text-njra-500 rounded border-gray-300 focus:ring-njra-500 cursor-pointer" 
                                                                checked={selectedForPrint.has(policy.id)} 
                                                                onChange={() => togglePrintSelection(policy.id)} 
                                                            />
                                                        </td>
                                                        <td onClick={() => onSelectPolicy(policy)} className="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500 cursor-pointer">{policy.code || '-'}</td>
                                                        <td onClick={() => onSelectPolicy(policy)} className="px-6 py-4 text-sm text-gray-900 font-medium cursor-pointer">{policy.title}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm">
                                                            <div className="flex justify-end gap-2">
                                                                <button onClick={() => onSelectPolicy(policy)} className="text-gray-500 hover:text-njra-500 font-bold px-2 py-1" title="View Policy"><i className="fas fa-eye"></i></button>
                                                                <button onClick={() => onTakeQuiz(policy)} className="njra-btn njra-btn-primary text-xs py-1 px-3" title="Take Competency"><i className="fas fa-graduation-cap mr-1"></i> Quiz</button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredPolicies.map((policy) => (
                                            <tr key={policy.id} className="hover:bg-njra-50">
                                                <td className="px-6 py-4 text-center w-12"><input type="checkbox" className="w-4 h-4" checked={selectedForPrint.has(policy.id)} onChange={() => togglePrintSelection(policy.id)} /></td>
                                                <td onClick={() => onSelectPolicy(policy)} className="px-6 py-4 font-mono text-gray-500 w-24 cursor-pointer">{policy.code}</td>
                                                <td onClick={() => onSelectPolicy(policy)} className="px-6 py-4 font-medium text-gray-900 cursor-pointer">{policy.title}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                );
            };

            const BatchPrintView = () => {
                const selectedList = policies.filter(p => selectedForPrint.has(p.id));
                return (
                    <div className="max-w-4xl mx-auto w-full bg-white p-12 min-h-screen">
                        <div className="no-print flex justify-between mb-8 pb-4 border-b">
                            <h2 className="text-2xl font-bold">Print Preview ({selectedList.length} Items)</h2>
                            <div className="flex gap-2">
                                <button onClick={() => window.print()} className="njra-btn njra-btn-primary"><i className="fas fa-print mr-2"></i> Print All</button>
                                <button onClick={() => setView('home')} className="njra-btn njra-btn-secondary">Back</button>
                            </div>
                        </div>

                        {/* COVER PAGE */}
                        <div className="print-cover-page border-4 border-double border-gray-800 p-12 mb-12">
                            <div className="text-5xl font-serif font-bold text-njra-900 mb-8">Policy and Procedure Manual</div>
                            <div className="w-32 h-1 bg-njra-500 mb-8"></div>
                            <div className="text-3xl text-gray-600">New Jersey Respiratory</div>
                            <div className="mt-auto text-sm text-gray-400">Generated: {new Date().toLocaleDateString()}</div>
                        </div>

                        {selectedList.map((policy, idx) => (
                            <div key={policy.id} className="print-page-break mb-12 border-b border-gray-200 pb-8 last:border-0">
                                <h1 className="text-3xl font-bold text-black mb-2">{policy.title}</h1>
                                <div className="text-sm text-gray-500 mb-6 flex gap-4">
                                    <span>Code: <strong>{policy.code}</strong></span>
                                    <span>Category: <strong>{policy.category}</strong></span>
                                </div>
                                <div className="policy-content" dangerouslySetInnerHTML={{__html: policy.content}}></div>
                            </div>
                        ))}
                    </div>
                );
            };

            const QuizComponent = ({ policy }) => {
                const [userAnswers, setUserAnswers] = useState({});
                const [showResult, setShowResult] = useState(false);
                const [score, setScore] = useState(0);
                const [userName, setUserName] = useState("");
                const [userEmail, setUserEmail] = useState(""); 
                const questions = policy.questions || [];
                const [isSendingEmail, setIsSendingEmail] = useState(false);
                const [emailSent, setEmailSent] = useState(false);
                
                if(questions.length === 0) return (<div className="max-w-2xl mx-auto mt-8 bg-white p-8 rounded border border-gray-300 shadow-md text-center"><div className="text-gray-400 text-4xl mb-4"><i className="fas fa-clipboard-list"></i></div><h2 className="text-xl font-bold text-gray-700">No Competency Data</h2><button onClick={()=>setView('detail')} className="mt-6 njra-btn njra-btn-secondary">Return</button></div>);

                const handleSelect = (qIdx, optIdx) => { if (showResult) return; setUserAnswers(prev => ({...prev, [qIdx]: optIdx})); };
                const handleSubmit = () => {
                    let correctCount = 0;
                    questions.forEach((q, idx) => { if (userAnswers[idx] === q.correctIndex) correctCount++; });
                    setScore(correctCount); setShowResult(true); window.scrollTo(0, document.body.scrollHeight);
                };
                const isPassed = (score / questions.length) >= 0.8;
                const percent = Math.round((score / questions.length) * 100);
                
                // NEW: Updated Email Logic
                const handleSendEmail = () => {
                    if (!userName || !userEmail) return;
                    setIsSendingEmail(true);
                    
                    const templateParams = {
                        policy_title: policy.title,
                        score: percent,
                        date: new Date().toLocaleDateString(),
                        user_name: userName,
                        user_email: userEmail,
                    };

                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                        .then(() => {
                            setEmailSent(true);
                            setIsSendingEmail(false);
                        }, (err) => {
                            alert("Failed to send email. Please check your configuration.");
                            console.error(err);
                            setIsSendingEmail(false);
                        });
                };
                
                const handlePrint = () => { window.print(); }

                return (
                    <div className="max-w-3xl mx-auto mt-8 w-full">
                        <div className="bg-white p-8 rounded border border-gray-300 shadow-md print:shadow-none print:border-none">
                            <div className="mb-8 border-b border-gray-200 pb-6 text-center">
                                <h1 className="text-2xl font-bold text-njra-900 mb-2">{policy.title}</h1>
                                <p className="text-gray-500">Competency Evaluation</p>
                                {showResult && (<div className={`mt-6 p-4 rounded-lg border-2 ${isPassed ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800'}`}><h2 className="text-2xl font-bold">{isPassed ? "PASSED" : "Not Met"}</h2><p className="font-bold text-lg">{percent}%</p></div>)}
                            </div>
                            <div className="print-only hidden">{isPassed && (<div className="border-4 border-double border-black p-8 m-4 text-center"><h1 className="text-4xl font-serif mb-6">Certificate of Competency</h1><p className="text-lg">Certifies that <strong>{userName}</strong> passed:</p><h3 className="text-xl font-bold my-4">{policy.title}</h3><p>Date: {new Date().toLocaleDateString()}</p></div>)}</div>
                            <div className={`space-y-8 ${showResult && isPassed ? 'print:hidden' : ''}`}>
                                {questions.map((q, idx) => {
                                    const userAnswer = userAnswers[idx];
                                    return (
                                        <div key={idx} className="quiz-question-block"><div className="flex gap-3 mb-3"><span className="font-bold text-gray-400">{idx + 1}.</span><h3 className="font-bold text-gray-800 text-lg">{q.text}</h3></div><div className="pl-8 space-y-2">{q.options.map((opt, oIdx) => {
                                            let itemClass = "block w-full text-left p-3 border rounded transition-all flex items-center ";
                                            if (showResult) {
                                                if (oIdx === q.correctIndex) itemClass += "bg-green-100 border-green-500 font-bold ";
                                                else if (oIdx === userAnswers[idx]) itemClass += "bg-red-50 border-red-500 ";
                                                else itemClass += "bg-gray-50 opacity-60 ";
                                            } else {
                                                if (userAnswer === oIdx) itemClass += "bg-njra-50 border-njra-500 font-medium ";
                                                else itemClass += "bg-white border-gray-300 hover:bg-gray-50 ";
                                            }
                                            return (<button key={oIdx} onClick={() => handleSelect(idx, oIdx)} disabled={showResult} className={itemClass}><div className={`w-4 h-4 rounded-full border mr-3 flex items-center justify-center ${userAnswers[idx] === oIdx ? 'border-njra-500 bg-njra-500' : 'border-gray-400'}`}>{userAnswer === oIdx && <div className="w-2 h-2 bg-white rounded-full"></div>}</div>{opt}</button>);
                                        })}</div></div>
                                    );
                                })}
                            </div>
                            <div className="mt-10 pt-6 border-t border-gray-200 no-print">{!showResult ? (<div className="flex justify-between items-center"><div className="text-sm text-gray-500">{Object.keys(userAnswers).length} / {questions.length} answered</div><button onClick={handleSubmit} disabled={Object.keys(userAnswers).length < questions.length} className={`njra-btn ${Object.keys(userAnswers).length < questions.length ? 'bg-gray-300 cursor-not-allowed' : 'njra-btn-primary'}`}>Submit</button></div>) : (
                                <div className="space-y-4 bg-gray-50 p-6 rounded-lg">
                                    <h4 className="font-bold text-gray-900">Next Steps:</h4>
                                    <div className="flex flex-col gap-2">
                                        <input className="border border-gray-300 p-3 w-full rounded focus:ring-2 focus:ring-njra-500 outline-none bg-white" placeholder="Enter Your Full Name" value={userName} onChange={e=>setUserName(e.target.value)} disabled={emailSent} />
                                        <input className="border border-gray-300 p-3 w-full rounded focus:ring-2 focus:ring-njra-500 outline-none bg-white" placeholder="Enter Your Email" value={userEmail} onChange={e=>setUserEmail(e.target.value)} disabled={emailSent} />
                                    </div>
                                    <div className="flex gap-3 flex-col sm:flex-row">
                                        {emailSent ? (
                                            <button disabled className="njra-btn bg-green-600 text-white flex-1 cursor-default">
                                                <i className="fas fa-check mr-2"></i> Email Sent!
                                            </button>
                                        ) : (
                                            <button onClick={handleSendEmail} disabled={!userName || !userEmail || isSendingEmail} className="njra-btn njra-btn-primary flex-1">
                                                <i className={`fas ${isSendingEmail ? 'fa-spinner fa-spin' : 'fa-paper-plane'} mr-2`}></i> {isSendingEmail ? 'Sending...' : 'Submit & Email'}
                                            </button>
                                        )}
                                        
                                        {isPassed && <button onClick={()=>window.print()} className="njra-btn njra-btn-secondary flex-1"><i className="fas fa-certificate mr-2"></i> Print Certificate</button>}
                                        <button onClick={()=>setView('home')} className="njra-btn njra-btn-outline flex-1">Close</button>
                                    </div>
                                </div>
                            )}</div>
                        </div>
                    </div>
                );
            };

            const handleAdminLogin = (e) => {
                e.preventDefault();
                if(adminPass === "NJRA2025") { setIsAdmin(true); setShowAdminLogin(false); setView('admin'); }
                else { alert("Incorrect Code"); }
            };

            return (
                <div className="min-h-[600px] flex flex-col w-full njra-inner-content">
                    <nav className="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40 no-print w-full rounded-b-lg">
                        <div className="px-4 py-4">
                            <div className="flex justify-between items-center w-full">
                                <div className="flex items-center cursor-pointer" onClick={() => setView('home')}>
                                    <span className="text-2xl mr-2 text-njra-500"><i className="fas fa-lungs"></i></span>
                                    <span className="text-xl font-bold text-njra-900">NJ Respiratory Policy Portal</span>
                                </div>
                                <div className="flex items-center space-x-3">
                                    <button onClick={() => setView('home')} className={`njra-btn ${view === 'home' ? 'njra-btn-secondary' : 'njra-btn-outline'}`}>Policies</button>
                                    <button type="button" onClick={() => setShowAdminLogin(true)} className="text-gray-400 hover:text-njra-500 p-2 cursor-pointer"><i className="fas fa-lock"></i></button>
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    {status && <div className="bg-yellow-50 text-yellow-800 text-center text-xs py-2 border-b border-yellow-200">{status}</div>}

                    <div className="w-full px-4 py-8 flex-grow">
                        {view === 'home' && (
                            <PolicyList 
                                policies={policies} 
                                onSelectPolicy={(p) => { setSelectedPolicy(p); setView('detail'); }} 
                                onTakeQuiz={(p) => { setSelectedPolicy(p); setView('quiz'); }}
                            />
                        )}

                        {view === 'batch_print' && <BatchPrintView />}

                        {view === 'detail' && selectedPolicy && (
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full">
                                <div className="bg-white p-8 border-b border-gray-200 flex justify-between items-start">
                                    <div>
                                        <div className="text-gray-400 text-sm mb-1 uppercase tracking-wide font-bold">{selectedPolicy.code}</div>
                                        <h1 className="text-3xl font-bold text-njra-500 m-0 border-0">{selectedPolicy.title}</h1>
                                        <div className="mt-2 text-sm text-gray-500 bg-gray-100 inline-block px-2 py-1 rounded">{selectedPolicy.category || "Uncategorized"}</div>
                                    </div>
                                    <button onClick={()=>setView('home')} className="text-gray-400 hover:text-njra-500 transition-colors"><i className="fas fa-times text-2xl"></i></button>
                                </div>
                                <div className="p-4 bg-gray-50 flex justify-end gap-3 border-b border-gray-200 no-print">
                                    <button onClick={()=>window.print()} className="njra-btn njra-btn-secondary"><i className="fas fa-print mr-2"></i>Print</button>
                                    <button onClick={()=>setView('quiz')} className="njra-btn njra-btn-primary"><i className="fas fa-graduation-cap mr-2"></i>Take Quiz</button>
                                </div>
                                <div className="p-12 policy-content text-gray-800 leading-relaxed" dangerouslySetInnerHTML={{__html: selectedPolicy.content}}></div>
                            </div>
                        )}

                        {view === 'quiz' && selectedPolicy && <QuizComponent policy={selectedPolicy} />}
                        
                        {view === 'admin' && (
                            <div className="bg-white p-8 rounded border border-gray-200 shadow-md">
                                <div className="flex justify-between items-center mb-6 border-b pb-4">
                                    <h2 className="text-xl font-bold text-njra-900">Admin Dashboard</h2>
                                    <button onClick={() => setView('home')} className="njra-btn njra-btn-secondary text-sm">Exit Admin Dashboard</button>
                                </div>
                                
                                <div className="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
                                    <h3 className="font-bold text-lg text-njra-900 mb-4">1. Configure Services</h3>
                                    <div className="flex items-center gap-2">
                                        <input type="password" placeholder="Paste OpenAI Key Here" className="border p-2 rounded text-xs w-full max-w-md" value={apiKey} onChange={handleApiKeyChange} />
                                        {apiKey && (
                                            <div className="flex gap-2">
                                                <button onClick={testOpenAIConnection} className="text-green-600 text-xs font-bold hover:underline">Test</button>
                                                <button onClick={resetApiKey} className="text-red-600 text-xs font-bold hover:underline">Reset</button>
                                            </div>
                                        )}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">Required for AI document processing.</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    {/* UPLOAD DOCS */}
                                    <div className="border border-gray-300 p-6 rounded flex flex-col gap-4 bg-white shadow-sm">
                                        <div>
                                            <h3 className="font-bold text-lg text-njra-900 mb-1">2. Upload Documents</h3>
                                            <p className="text-xs text-gray-500">Select multiple .docx files to auto-generate policies.</p>
                                        </div>
                                        <label className={`njra-btn njra-btn-secondary cursor-pointer w-full text-center justify-center ${isProcessing ? 'opacity-50' : ''}`}>
                                            {isProcessing ? <i className="fas fa-spinner fa-spin mr-2"></i> : <i className="fas fa-file-upload mr-2"></i>}
                                            <span>{isProcessing ? 'Analyzing...' : 'Select Word Files'}</span>
                                            <input type="file" accept=".docx" multiple className="hidden" onChange={handleFileSelect} disabled={isProcessing} />
                                        </label>
                                    </div>

                                    {/* CREATE NEW */}
                                    <div className="border border-gray-300 p-6 rounded flex flex-col gap-4 bg-white shadow-sm">
                                        <div>
                                            <h3 className="font-bold text-lg text-njra-900 mb-1">3. Create from Topic</h3>
                                            <p className="text-xs text-gray-500">Type a topic and let AI write the policy for you.</p>
                                        </div>
                                        <div className="flex gap-2 mt-auto">
                                            <input type="text" className="border p-2 rounded flex-grow text-sm" placeholder="e.g. Hand Hygiene" value={newPolicyTopic} onChange={e=>setNewPolicyTopic(e.target.value)} />
                                            <button onClick={createFromTopic} disabled={isProcessing} className="njra-btn njra-btn-primary"><i className="fas fa-magic"></i></button>
                                        </div>
                                    </div>
                                </div>

                                {/* Upload Queue Section */}
                                {uploadQueue.length > 0 && !isProcessing && (
                                    <div className="border-t border-gray-200 pt-6 mb-6">
                                        <h4 className="font-bold text-gray-800 mb-2">Selected Documents ({uploadQueue.length})</h4>
                                        <ul className="mb-4 space-y-2">
                                            {uploadQueue.map((file, idx) => (
                                                <li key={idx} className="flex justify-between items-center text-sm bg-white p-2 rounded border border-gray-200">
                                                    <span>{file.name}</span>
                                                    <button onClick={() => removeFile(idx)} className="text-red-500 hover:text-red-700"><i className="fas fa-trash"></i></button>
                                                </li>
                                            ))}
                                        </ul>
                                        <div className="flex gap-3 justify-end">
                                            <button onClick={() => setUploadQueue([])} className="njra-btn njra-btn-secondary">Clear Queue</button>
                                            <button onClick={processQueue} className="njra-btn njra-btn-primary">Process & Save</button>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <h3 className="font-bold mb-4 text-njra-900 border-b pb-2">Database Content ({policies.length})</h3>
                                    <ul>
                                        {policies.sort((a,b) => (a.code||"").localeCompare(b.code||"")).map(p => (
                                            <li key={p.id} className="flex justify-between items-center py-3 border-b hover:bg-gray-50 px-2 flex-wrap gap-2">
                                                <div className="flex flex-col">
                                                    <span className="text-gray-800 font-medium">
                                                        <span className="font-mono text-xs text-gray-500 mr-2 w-16 inline-block">{p.code || '-'}</span>
                                                        {p.title}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-2 ml-auto">
                                                    <select 
                                                        className="text-xs border rounded p-1 max-w-[140px] bg-white"
                                                        value={p.category || "Uncategorized"}
                                                        onChange={(e) => updateDbCategory(p.id, e.target.value)}
                                                    >
                                                        {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                                    </select>
                                                    <button onClick={()=>handleDelete(p.id)} className="text-red-500 hover:text-red-700 p-2" title="Delete"><i className="fas fa-trash"></i></button>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        )}
                    </div>
                    {showAdminLogin && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm border border-gray-200">
                                <h3 className="font-bold mb-6 text-xl text-njra-900 text-center">Admin Access</h3>
                                <form onSubmit={handleAdminLogin}>
                                    <input type="password" placeholder="Code" className="w-full border border-gray-300 p-3 mb-6 rounded outline-none" value={adminPass} onChange={e=>setAdminPass(e.target.value)}/>
                                    <div className="flex gap-4"><button type="button" onClick={()=>setShowAdminLogin(false)} className="njra-btn njra-btn-secondary flex-1">Cancel</button><button type="submit" className="njra-btn njra-btn-primary flex-1">Login</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                    <div className="text-center py-4 text-gray-400 text-xs mt-auto bg-white border-t border-gray-200">
                        &copy; 2025 New Jersey Respiratory, Inc / All rights reserved - Last Updated: {lastUpdated}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('njra-app-root'));
        root.render(<App />);
    </script>
</body>
</html>
