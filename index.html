<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NJ Respiratory Policy Portal</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAefsgDE8YT1MLwC0wTEsFB799vKbStgyk",
            authDomain: "njra-policies.firebaseapp.com",
            projectId: "njra-policies",
            storageBucket: "njra-policies.firebasestorage.app",
            messagingSenderId: "779465511706",
            appId: "1:779465511706:web:d3fb672bcc89f168d892a3",
            measurementId: "G-2046SMFN0T"
        };
        
        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            // Expose for React
            window.collection = collection; window.addDoc = addDoc; window.getDocs = getDocs; 
            window.updateDoc = updateDoc; window.deleteDoc = deleteDoc; window.setDoc = setDoc; 
            window.getDoc = getDoc; window.doc = doc; window.onSnapshot = onSnapshot; 
            window.query = query; window.orderBy = orderBy; window.where = where; 
            window.signInAnonymously = signInAnonymously;
        } catch (e) { console.error("Firebase Init Error:", e); }
    </script>

    <script>
        const EMAILJS_SERVICE_ID = "service_e8rbn3f";   
        const EMAILJS_TEMPLATE_ID = "template_tnqja7a"; 
        const EMAILJS_PUBLIC_KEY = "I-fs7ljzMeCgNUEGJ"; 

        (function(){ try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) {} })();

        tailwind.config = {
            corePlugins: { preflight: false }, 
            theme: {
                extend: {
                    colors: {
                        njra: { 50: '#fdf2f2', 100: '#fde8e8', 500: '#af3030', 600: '#942626', 700: '#7f1d1d', 900: '#444444' },
                        quik: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#0f766e', 600: '#0d5f58' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        #njra-app-root { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #1f2937; line-height: 1.5; width: 100%; min-height: 100vh; }
        
        .njra-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .njra-btn-primary { background-color: #af3030 !important; color: white !important; }
        .njra-btn-primary:hover { background-color: #942626 !important; transform: translateY(-1px); }
        .njra-btn-quik { background-color: #0f766e !important; color: white !important; }
        .njra-btn-quik:hover { background-color: #0d5f58 !important; transform: translateY(-1px); }
        .njra-btn-secondary { background-color: #374151 !important; color: white !important; }
        .njra-btn-outline { background-color: #ffffff !important; color: #374151 !important; border: 1px solid #d1d5db !important; }
        .njra-btn-outline:hover { background-color: #f9fafb !important; border-color: #9ca3af !important; }

        .policy-content h1 { color: #af3030; font-size: 1.8rem; font-weight: 800; border-bottom: 2px solid #fbd5d5; padding-bottom: 0.5rem; margin-top: 1.5rem; margin-bottom: 1rem; }
        .policy-content h2 { color: #1f2937; font-size: 1.4rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .policy-content p { margin-bottom: 1rem; color: #374151; line-height: 1.7; }
        .policy-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            #njra-app-root { border: none; width: 100% !important; margin: 0 !important; }
            .print-page-break { page-break-before: always; }
            .print-avoid-break { page-break-inside: avoid; }
            .print-cover-page { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; page-break-after: always; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="njra-app-root">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #af3030;">
            <i class="fas fa-circle-notch fa-spin fa-3x mb-4"></i>
            <p style="color: #4b5563; font-weight: 600;">Loading Portal...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const CATEGORIES = ["Emergency Procedures", "Clinical Care", "Equipment Management", "Patient Assessment", "Infection Control", "Documentation", "Administrative", "Uncategorized"];
        
        // --- DATA & AI HELPERS ---
        const cleanAndParseJSON = (text) => {
            let cleanText = text.trim().replace(/^```json/, "").replace(/^```/, "").replace(/```$/, "");
            return JSON.parse(cleanText);
        };

        const SYSTEM_PROMPT = `
            You are an expert Respiratory Therapy consultant for Long-Term Care (LTC) facilities.
            OBJECTIVE: Create/Update a policy.
            GUIDELINES: Professional tone, HTML formatting (<h2>, <p>, <ul>), Compliance-forward.
            OUTPUT FORMAT (JSON): { "title": "...", "code": "...", "category": "...", "content": "HTML...", "questions": [{ "text": "...", "options": ["A","B"], "correctIndex": 0 }] }
        `;

        const App = () => {
            const [view, setView] = useState('home');
            const [policies, setPolicies] = useState([]);
            const [bundles, setBundles] = useState([]);
            
            const [selectedPolicy, setSelectedPolicy] = useState(null);
            const [activeBundle, setActiveBundle] = useState(null); 
            const [courseState, setCourseState] = useState({ active: false, index: 0, mode: 'read' }); 
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [adminPass, setAdminPass] = useState("");
            const [status, setStatus] = useState("");
            const [apiKey, setApiKey] = useState(localStorage.getItem('njra_openai_key') || "");
            const [uploadQueue, setUploadQueue] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [newPolicyTopic, setNewPolicyTopic] = useState("");
            const [lastUpdated, setLastUpdated] = useState("Loading...");

            useEffect(() => {
                const init = async () => {
                    try {
                        if (window.auth && window.db) {
                            await window.signInAnonymously(window.auth);
                            window.onSnapshot(window.query(window.collection(window.db, 'policies'), window.orderBy('title')), (s) => setPolicies(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                            window.onSnapshot(window.query(window.collection(window.db, 'bundles'), window.orderBy('title')), (s) => setBundles(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                            window.onSnapshot(window.doc(window.db, 'metadata', 'system'), (d) => { if(d.exists()) setLastUpdated(d.data().lastUpdated); });
                        }
                    } catch (e) { console.error(e); }
                };
                init();
            }, []);

            const updateSystemTimestamp = async () => {
                const now = new Date().toLocaleString();
                await window.setDoc(window.doc(window.db, 'metadata', 'system'), { lastUpdated: now });
            };

            const callAI = async (userContent) => {
                const response = await fetch("[https://api.openai.com/v1/chat/completions](https://api.openai.com/v1/chat/completions)", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "system", content: SYSTEM_PROMPT }, { role: "user", content: userContent }], response_format: { type: "json_object" } })
                });
                if (!response.ok) throw new Error("AI Error");
                return await response.json();
            };

            const processQueue = async () => {
                if (!apiKey) return alert("API Key Required");
                setIsProcessing(true);
                try {
                    for (let file of uploadQueue) {
                        setStatus(`Processing ${file.name}...`);
                        const ab = await file.arrayBuffer();
                        const raw = (await mammoth.extractRawText({ arrayBuffer: ab })).value;
                        const data = await callAI(`Reformat this policy:\n\n${raw}`);
                        const json = cleanAndParseJSON(data.choices[0].message.content);
                        const items = json.policies || (Array.isArray(json) ? json : [json]);
                        for(let item of items) await window.addDoc(window.collection(window.db, 'policies'), item);
                    }
                    await updateSystemTimestamp();
                    alert("Processing Complete!");
                    setUploadQueue([]);
                } catch(e) { alert("Error: " + e.message); }
                setIsProcessing(false); setStatus("");
            };

            const createFromTopic = async () => { 
                if(!newPolicyTopic) return; 
                setIsProcessing(true); 
                try { 
                    const data = await callAI(`Create respiratory policy/quiz for: "${newPolicyTopic}"`); 
                    const json = cleanAndParseJSON(data.choices[0].message.content); 
                    await window.addDoc(window.collection(window.db, 'policies'), json); 
                    await updateSystemTimestamp();
                    alert("Created!"); 
                    setNewPolicyTopic(""); 
                } catch(e) { alert(e.message); } 
                setIsProcessing(false); 
            };

            const runPolicyUpdate = async (policy) => {
                if (!apiKey) return alert("Please enter API Key");
                if (!confirm(`AI Update for "${policy.title}"?`)) return;
                setIsProcessing(true);
                try {
                    const data = await callAI(`${SYSTEM_PROMPT}\n\nTASK: Update this policy code "${policy.code}". Content: ${policy.content}`);
                    const content = cleanAndParseJSON(data.choices[0].message.content);
                    const updatedItem = Array.isArray(content) ? content[0] : (content.policies ? content.policies[0] : content);
                    await window.updateDoc(window.doc(window.db, 'policies', policy.id), updatedItem);
                    await updateSystemTimestamp();
                    alert("Updated!");
                } catch(e) { alert(e.message); }
                setIsProcessing(false);
            };

            const updateDbCategory = async (id, newCat) => { try { await window.updateDoc(window.doc(window.db, 'policies', id), { category: newCat }); await updateSystemTimestamp(); } catch(e) { alert("Update failed: " + e.message); } };
            const handleDelete = async (id) => { if(!confirm("Delete?")) return; try { await window.deleteDoc(window.doc(window.db, 'policies', id)); await updateSystemTimestamp(); } catch(e) { alert(e.message); } };

            const startCourse = (bundle) => { setActiveBundle(bundle); setCourseState({ active: true, index: 0, mode: 'read' }); setView('course_player'); };
            const handleCourseStepComplete = (passed) => {
                if (!passed) return; 
                const bundlePolicies = policies.filter(p => activeBundle.policyIds.includes(p.id));
                if (courseState.index + 1 < bundlePolicies.length) { setCourseState({ ...courseState, index: courseState.index + 1, mode: 'read' }); window.scrollTo(0, 0); } 
                else { setCourseState({ ...courseState, mode: 'summary' }); window.scrollTo(0, 0); }
            };
            const printInstructorGuide = (bundle) => { setActiveBundle(bundle); setView('instructor_print'); setTimeout(() => window.print(), 500); };

            // --- COMPONENTS ---

            const BundleCard = ({ bundle }) => (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-lg transition-all transform hover:-translate-y-1 overflow-hidden group">
                    <div className="h-2 bg-quik-500 w-full"></div>
                    <div className="p-6">
                        <div className="flex justify-between items-start mb-4">
                            <div className="p-3 bg-quik-50 rounded-lg text-quik-600">
                                <i className="fas fa-layer-group text-xl"></i>
                            </div>
                            <span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">
                                {bundle.policyIds ? bundle.policyIds.length : 0} Modules
                            </span>
                        </div>
                        <h3 className="font-bold text-lg text-gray-800 mb-2 group-hover:text-quik-600 transition-colors">{bundle.title}</h3>
                        <p className="text-sm text-gray-500 mb-6 line-clamp-2">{bundle.description}</p>
                        <div className="flex gap-2">
                            <button onClick={() => startCourse(bundle)} className="flex-1 njra-btn njra-btn-quik text-sm">
                                <i className="fas fa-play mr-2"></i> Start
                            </button>
                            <button onClick={() => printInstructorGuide(bundle)} className="njra-btn njra-btn-outline text-sm" title="Instructor Guide">
                                <i className="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );

            const PolicyList = () => {
                const [searchTerm, setSearchTerm] = useState("");
                const filteredPolicies = policies.filter(p => p.title.toLowerCase().includes(searchTerm.toLowerCase()) || (p.code && p.code.toLowerCase().includes(searchTerm.toLowerCase())));
                
                return (
                    <div className="w-full flex-grow bg-gray-50 min-h-screen flex flex-col">
                        <div className="max-w-6xl mx-auto px-6 py-10 w-full">
                            
                            {/* CLEAN SEARCH BOX */}
                            <div className="text-center mb-10 bg-white p-10 rounded-xl shadow-sm border border-gray-100">
                                <h1 className="text-3xl font-extrabold text-njra-500 mb-2">Policy & Competency Portal</h1>
                                <p className="text-gray-500 mb-6">Search clinical protocols, staff competencies, and training bundles.</p>
                                <div className="max-w-xl mx-auto relative">
                                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                                        <i className="fas fa-search"></i>
                                    </div>
                                    <input 
                                        type="text" 
                                        className="block w-full pl-12 pr-4 py-3 border border-gray-200 rounded-full bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-njra-500 focus:border-transparent transition-all shadow-inner" 
                                        placeholder="Search keywords, codes, or topics..." 
                                        value={searchTerm} 
                                        onChange={(e) => setSearchTerm(e.target.value)} 
                                    />
                                </div>
                            </div>
                            
                            {/* BUNDLES */}
                            {bundles.length > 0 && !searchTerm && (
                                <div className="mb-12 animate-fade-in">
                                    <div className="flex items-center gap-2 mb-4 ml-1">
                                        <h2 className="text-xl font-bold text-gray-800">QuikComp Bundles</h2>
                                        <span className="bg-quik-100 text-quik-600 text-xs px-2 py-0.5 rounded-full font-bold">New</span>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {bundles.map(b => <BundleCard key={b.id} bundle={b} />)}
                                    </div>
                                </div>
                            )}

                            {/* POLICY TABLE */}
                            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden animate-fade-in">
                                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-gray-100 rounded text-gray-500"><i className="fas fa-file-alt"></i></div>
                                        <div>
                                            <h2 className="text-lg font-bold text-gray-800">Document Library</h2>
                                            <p className="text-xs text-gray-500">Last Updated: {lastUpdated}</p>
                                        </div>
                                    </div>
                                    <span className="text-sm text-gray-400 bg-gray-50 px-3 py-1 rounded-full border border-gray-200 font-mono">
                                        {filteredPolicies.length} Records
                                    </span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-100">
                                        <thead className="bg-gray-50/50">
                                            <tr>
                                                <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Code</th>
                                                <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Policy Title</th>
                                                <th className="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell">Category</th>
                                                <th className="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-100">
                                            {filteredPolicies.map(p => (
                                                <tr key={p.id} className="hover:bg-blue-50/30 transition-colors group">
                                                    <td onClick={()=> {setSelectedPolicy(p); setView('detail');}} className="px-6 py-4 whitespace-nowrap font-mono text-sm text-gray-500 cursor-pointer group-hover:text-blue-600 font-medium">
                                                        {p.code || <span className="text-gray-300">-</span>}
                                                    </td>
                                                    <td onClick={()=> {setSelectedPolicy(p); setView('detail');}} className="px-6 py-4 text-sm text-gray-800 font-medium cursor-pointer group-hover:text-blue-600">
                                                        {p.title}
                                                    </td>
                                                    <td className="px-6 py-4 hidden md:table-cell">
                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                            {p.category || "General"}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button onClick={()=>{setSelectedPolicy(p); setView('quiz');}} className="text-quik-600 hover:text-quik-500 bg-quik-50 hover:bg-quik-100 px-3 py-1 rounded transition-colors font-bold text-xs">
                                                            Take Quiz
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {filteredPolicies.length === 0 && (
                                                <tr>
                                                    <td colSpan="4" className="px-6 py-12 text-center text-gray-400">
                                                        <i className="fas fa-folder-open text-4xl mb-3 opacity-20"></i>
                                                        <p>No documents found matching "{searchTerm}"</p>
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-auto bg-white border-t border-gray-200 py-6 text-center text-xs text-gray-400">
                            &copy; 2025 New Jersey Respiratory Associates. Internal Use Only.
                        </div>
                    </div>
                );
            };

            const CoursePlayer = () => {
                const bundlePolicies = policies.filter(p => activeBundle.policyIds.includes(p.id));
                const currentPolicy = bundlePolicies[courseState.index];
                if (courseState.mode === 'summary') {
                    return (
                        <div className="max-w-4xl mx-auto p-8 bg-white rounded-xl shadow-lg text-center mt-10 border border-gray-100">
                            <div className="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 text-yellow-500 text-4xl"><i className="fas fa-trophy"></i></div>
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">Bundle Completed!</h1>
                            <p className="text-lg text-gray-500 mb-8">You have successfully completed <strong>{activeBundle.title}</strong>.</p>
                            <div className="flex justify-center gap-4 no-print">
                                <button onClick={()=>window.print()} className="njra-btn njra-btn-primary"><i className="fas fa-certificate mr-2"></i> Print Certificate</button>
                                <button onClick={()=>setView('home')} className="njra-btn njra-btn-outline">Return Home</button>
                            </div>
                            <div className="print-only print-cover-page border-8 border-double border-njra-900 p-12">
                                <div className="text-5xl font-serif font-bold text-njra-500 mb-8">Certificate of Completion</div>
                                <h2 className="text-4xl font-bold border-b-2 border-black pb-4 mb-4 inline-block">{activeBundle.title}</h2>
                                <div className="text-left mt-8 w-full max-w-2xl mx-auto"><p className="font-bold mb-2">Modules Verified:</p><ul className="list-disc pl-5">{bundlePolicies.map((p,i) => <li key={i} className="mb-1">{p.title}</li>)}</ul></div>
                                <div className="mt-auto w-full flex justify-between px-12 pt-12"><div className="text-center border-t border-black pt-2 w-64">Employee Signature</div><div className="text-center border-t border-black pt-2 w-64">Instructor Signature</div></div>
                            </div>
                        </div>
                    );
                }
                return (
                    <div className="max-w-5xl mx-auto w-full bg-white min-h-screen flex flex-col shadow-2xl">
                        <div className="bg-quik-600 text-white p-4 sticky top-0 z-30 shadow-md flex items-center justify-between">
                            <div className="flex items-center"><h2 className="font-bold text-lg"><i className="fas fa-layer-group mr-3 opacity-50"></i> {activeBundle.title}</h2></div>
                            <button onClick={()=>{if(confirm("Exit course?")) setView('home')}} className="text-white/70 hover:text-white"><i className="fas fa-times"></i></button>
                        </div>
                        <div className="w-full bg-gray-200 h-1"><div className="bg-quik-500 h-1 transition-all duration-500" style={{width: `${((courseState.index)/bundlePolicies.length)*100}%`}}></div></div>
                        <div className="flex-grow p-8 bg-gray-50">
                            <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex justify-between items-center mb-6 border-b pb-4">
                                    <div><span className="text-xs font-bold text-gray-400 uppercase tracking-wide">Module {courseState.index + 1} of {bundlePolicies.length}</span><h1 className="text-2xl font-bold text-gray-900">{currentPolicy.title}</h1></div>
                                    <div className="flex bg-gray-100 p-1 rounded-lg"><button onClick={()=>setCourseState(p=>({...p, mode:'read'}))} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${courseState.mode==='read' ? 'bg-white shadow text-quik-600' : 'text-gray-500'}`}>Read</button><button onClick={()=>setCourseState(p=>({...p, mode:'quiz'}))} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${courseState.mode==='quiz' ? 'bg-white shadow text-quik-600' : 'text-gray-500'}`}>Quiz</button></div>
                                </div>
                                {courseState.mode === 'read' ? (
                                    <div className="animate-fade-in"><div className="policy-content prose max-w-none text-gray-700" dangerouslySetInnerHTML={{__html: currentPolicy.content}}></div><div className="mt-8 pt-6 border-t flex justify-end"><button onClick={()=>setCourseState(p=>({...p, mode:'quiz'}))} className="njra-btn njra-btn-quik text-lg px-8 py-3 shadow-lg hover:shadow-xl">Take Competency Quiz <i className="fas fa-arrow-right ml-2"></i></button></div></div>
                                ) : (
                                    <div className="animate-fade-in"><QuizComponent policy={currentPolicy} isCourseMode={true} onPass={()=>handleCourseStepComplete(true)} /></div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const InstructorGuideView = () => {
                const bundlePolicies = policies.filter(p => activeBundle.policyIds.includes(p.id));
                return (
                    <div className="max-w-4xl mx-auto bg-white p-12 min-h-screen">
                        <div className="no-print flex justify-between mb-8 pb-4 border-b"><h2 className="text-2xl font-bold">Instructor Guide Preview</h2><div className="flex gap-2"><button onClick={()=>window.print()} className="njra-btn njra-btn-primary"><i className="fas fa-print mr-2"></i> Print Guide</button><button onClick={()=>setView('home')} className="njra-btn njra-btn-secondary">Close</button></div></div>
                        <div className="print-cover-page border-4 border-double border-gray-800 p-12"><div className="text-4xl font-bold text-njra-900 mb-4">Instructor Training Guide</div><div className="text-2xl text-gray-600 mb-8">{activeBundle.title}</div><div className="mt-auto font-bold text-red-600 border-2 border-red-600 px-4 py-2 rounded">CONTAINS ANSWER KEYS</div></div>
                        {bundlePolicies.map((policy) => (
                            <div key={policy.id} className="print-page-break mb-12 border-b-4 border-gray-300 pb-8">
                                <div className="flex justify-between items-end border-b-2 border-black pb-2 mb-6"><h1 className="text-3xl font-bold text-black m-0">{policy.title}</h1><span className="font-mono text-gray-500">{policy.code}</span></div>
                                <div className="policy-content mb-8" dangerouslySetInnerHTML={{__html: policy.content}}></div>
                                <div className="bg-gray-50 p-6 border-2 border-dashed border-gray-400 print:bg-white print:border-black"><h3 className="text-xl font-bold text-black mb-4 uppercase"><i className="fas fa-key"></i> Competency Answer Key</h3><div className="space-y-4">{policy.questions && policy.questions.map((q, qIdx) => (<div key={qIdx} className="print-avoid-break"><div className="font-bold text-black mb-1">{qIdx + 1}. {q.text}</div><ul className="pl-6 list-[lower-alpha]">{q.options.map((opt, oIdx) => (<li key={oIdx} className={oIdx === q.correctIndex ? "correct-answer" : "text-gray-600"}>{opt}</li>))}</ul></div>))}</div></div>
                            </div>
                        ))}
                    </div>
                );
            };

            const QuizComponent = ({ policy, isCourseMode = false, onPass }) => {
                const [userAnswers, setUserAnswers] = useState({});
                const [showResult, setShowResult] = useState(false);
                const [score, setScore] = useState(0);
                const questions = policy.questions || [];
                const handleSubmit = () => { let correctCount = 0; questions.forEach((q, idx) => { if (userAnswers[idx] === q.correctIndex) correctCount++; }); setScore(correctCount); setShowResult(true); };
                const isPassed = (score / questions.length) >= 0.8;
                return (
                    <div>
                         {showResult && (<div className={`mb-6 p-6 rounded-lg border-l-4 text-center shadow-sm animate-fade-in ${isPassed ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800'}`}><h2 className="text-2xl font-bold mb-2">{isPassed ? "COMPETENCY MET" : "Not Met - Please Review"}</h2><p className="font-bold text-3xl mb-4">{Math.round((score/questions.length)*100)}%</p>{isCourseMode && isPassed && (<button onClick={onPass} className="njra-btn bg-green-700 text-white text-lg shadow-lg">Next Module <i className="fas fa-arrow-right ml-2"></i></button>)}</div>)}
                        <div className="space-y-6">{questions.map((q, idx) => (<div key={idx} className="bg-white p-5 rounded-lg border border-gray-200 shadow-sm"><div className="font-bold text-gray-800 mb-4 text-lg">{idx + 1}. {q.text}</div><div className="space-y-3">{q.options.map((opt, oIdx) => (<button key={oIdx} onClick={() => !showResult && setUserAnswers(p=>({...p, [idx]:oIdx}))} disabled={showResult} className={`block w-full text-left p-4 rounded-lg flex items-center transition-all ${showResult ? (oIdx===q.correctIndex?'bg-green-100 border-2 border-green-500 font-bold':(userAnswers[idx]===oIdx?'bg-red-50 border-2 border-red-500':'opacity-50 border border-gray-200')) : (userAnswers[idx]===oIdx?'bg-njra-50 border-2 border-njra-500 font-medium shadow-md':'border border-gray-200 hover:bg-gray-50 hover:border-gray-300')}`}>{opt}</button>))}</div></div>))}</div>
                        {!showResult && (<div className="mt-8 text-right"><button onClick={handleSubmit} disabled={Object.keys(userAnswers).length < questions.length} className={`njra-btn text-lg px-8 py-3 ${Object.keys(userAnswers).length < questions.length ? 'bg-gray-200 text-gray-400' : 'njra-btn-primary shadow-lg'}`}>Submit Competency</button></div>)}
                    </div>
                );
            };

            const AdminDashboard = () => {
                const [title, setTitle] = useState("");
                const [desc, setDesc] = useState("");
                const [selectedIds, setSelectedIds] = useState(new Set());
                const [adminSearch, setAdminSearch] = useState("");

                const saveBundle = async () => { 
                    if(!title) return alert("Title required");
                    await window.addDoc(window.collection(window.db, 'bundles'), { title, description: desc, policyIds: Array.from(selectedIds) }); 
                    alert("Bundle Saved"); setTitle(""); setDesc(""); setSelectedIds(new Set()); 
                };

                const filteredDbPolicies = policies.filter(p => p.title.toLowerCase().includes(adminSearch.toLowerCase()));

                return (
                    <div className="max-w-6xl mx-auto p-8 bg-white min-h-screen">
                         <div className="flex justify-between items-center mb-8 border-b pb-4">
                             <h2 className="text-2xl font-bold text-njra-900">Admin Dashboard</h2>
                             <button onClick={() => setView('home')} className="njra-btn njra-btn-secondary text-sm">Exit Admin</button>
                         </div>
                         
                         {/* 1. CONFIG & UPLOAD GRID */}
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                            {/* CONFIG */}
                            <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="font-bold text-lg text-njra-900 mb-4 border-b pb-2">1. System Configuration</h3>
                                <div className="space-y-4">
                                    <input type="password" placeholder="OpenAI API Key" className="w-full border p-3 rounded-lg focus:ring-2 focus:ring-njra-500 outline-none" value={apiKey} onChange={e=>setApiKey(e.target.value)} />
                                    <div className="flex gap-2">
                                        <input className="w-full border p-3 rounded-lg focus:ring-2 focus:ring-njra-500 outline-none" placeholder="Generate Topic (e.g. Fire Safety)" value={newPolicyTopic} onChange={e=>setNewPolicyTopic(e.target.value)} />
                                        <button onClick={createFromTopic} disabled={isProcessing} className="njra-btn njra-btn-primary whitespace-nowrap">{isProcessing?'...':'Generate'}</button>
                                    </div>
                                </div>
                            </div>
                            
                            {/* UPLOAD */}
                            <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="font-bold text-lg text-njra-900 mb-4 border-b pb-2">2. Batch Upload</h3>
                                <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <i className="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                        <p className="text-sm text-gray-500">Click to upload .docx files</p>
                                    </div>
                                    <input type="file" multiple className="hidden" onChange={e=>setUploadQueue(Array.from(e.target.files))} />
                                </label>
                                {uploadQueue.length > 0 && (
                                    <button onClick={processQueue} className="mt-4 w-full njra-btn njra-btn-primary shadow-lg">
                                        Process {uploadQueue.length} Files with AI
                                    </button>
                                )}
                            </div>
                         </div>

                         {/* 3. MANAGE DATABASE (RESTORED) */}
                         <div className="bg-white border border-gray-200 rounded-xl shadow-sm mb-10 overflow-hidden">
                             <div className="p-6 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                 <h3 className="font-bold text-lg text-njra-900">3. Manage Database</h3>
                                 <input type="text" placeholder="Search Policies..." className="border p-2 rounded text-sm w-64" value={adminSearch} onChange={e=>setAdminSearch(e.target.value)} />
                             </div>
                             <div className="max-h-80 overflow-y-auto">
                                 {filteredDbPolicies.map(p => (
                                     <div key={p.id} className="flex justify-between items-center p-4 border-b hover:bg-gray-50 transition-colors">
                                         <div className="flex-1">
                                             <div className="font-bold text-gray-800">{p.title}</div>
                                             <div className="text-xs text-gray-500 font-mono">{p.code}</div>
                                         </div>
                                         <div className="flex items-center gap-3">
                                             <button onClick={() => runPolicyUpdate(p)} className="text-blue-600 hover:text-blue-800 text-xs font-bold border border-blue-200 bg-blue-50 px-2 py-1 rounded flex items-center gap-1" title="Run AI Update">
                                                <i className="fas fa-magic"></i> AI Update
                                             </button>
                                             <select 
                                                className="text-xs border rounded p-1 bg-white"
                                                value={p.category || "Uncategorized"}
                                                onChange={(e) => updateDbCategory(p.id, e.target.value)}
                                             >
                                                {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                             </select>
                                             <button onClick={()=>handleDelete(p.id)} className="text-red-500 hover:text-red-700 p-2"><i className="fas fa-trash"></i></button>
                                         </div>
                                     </div>
                                 ))}
                             </div>
                         </div>

                         {/* 4. QUIKCOMP BUILDER (RESTORED) */}
                         <div className="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
                            <h3 className="font-bold text-lg text-quik-600 mb-4 border-b pb-2">4. QuikComp Bundle Builder</h3>
                            <div className="flex flex-col md:flex-row gap-8">
                                <div className="flex-1 space-y-4">
                                    <input className="w-full border p-3 rounded-lg" placeholder="Bundle Title (e.g. ICU Orientation)" value={title} onChange={e=>setTitle(e.target.value)} />
                                    <textarea className="w-full border p-3 rounded-lg" placeholder="Short Description" value={desc} onChange={e=>setDesc(e.target.value)} rows="2"></textarea>
                                    <div className="h-64 overflow-y-auto border p-2 rounded-lg bg-gray-50">
                                        <p className="text-xs font-bold text-gray-400 uppercase mb-2 px-2">Select Policies to Include:</p>
                                        {policies.map(p=>(
                                            <div key={p.id} className="flex items-center gap-2 p-2 hover:bg-white rounded cursor-pointer">
                                                <input type="checkbox" checked={selectedIds.has(p.id)} onChange={()=>{const s=new Set(selectedIds); if(s.has(p.id)) s.delete(p.id); else s.add(p.id); setSelectedIds(s);}} />
                                                <span className="text-sm">{p.title}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={saveBundle} className="w-full njra-btn njra-btn-quik shadow-md">Save New Bundle</button>
                                </div>
                                <div className="flex-1 border-l pl-8">
                                    <h4 className="font-bold text-gray-700 mb-4">Existing Bundles</h4>
                                    <div className="space-y-3">
                                        {bundles.map(b=>(
                                            <div key={b.id} className="flex justify-between items-center p-3 border rounded-lg bg-gray-50">
                                                <div>
                                                    <div className="font-bold text-sm text-gray-800">{b.title}</div>
                                                    <div className="text-xs text-gray-500">{b.policyIds ? b.policyIds.length : 0} Modules</div>
                                                </div>
                                                <button onClick={()=>window.deleteDoc(window.doc(window.db,'bundles',b.id))} className="text-red-400 hover:text-red-600"><i className="fas fa-trash"></i></button>
                                            </div>
                                        ))}
                                        {bundles.length === 0 && <p className="text-sm text-gray-400 italic">No bundles created yet.</p>}
                                    </div>
                                </div>
                            </div>
                         </div>
                    </div>
                );
            };

            // --- MAIN RENDER ---
            return (
                <div className="min-h-screen flex flex-col w-full njra-inner-content bg-gray-50">
                    {/* NAV BAR */}
                    {view !== 'course_player' && view !== 'instructor_print' && (
                        <nav className="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40 no-print">
                            <div className="px-6 py-4 flex justify-between items-center max-w-7xl mx-auto">
                                <div className="flex items-center cursor-pointer" onClick={() => setView('home')}>
                                    <span className="text-2xl mr-2 text-njra-500"><i className="fas fa-lungs"></i></span>
                                    <span className="text-xl font-bold text-gray-800">NJ Respiratory</span>
                                </div>
                                <button onClick={()=>setShowAdminLogin(true)} className="text-gray-400 hover:text-njra-500 transition-colors">
                                    <i className="fas fa-lock"></i>
                                </button>
                            </div>
                        </nav>
                    )}
                    {status && <div className="bg-yellow-50 text-yellow-800 text-center text-xs py-2 border-b border-yellow-200">{status}</div>}
                    
                    {view === 'home' && <PolicyList />}
                    {view === 'course_player' && <CoursePlayer />}
                    {view === 'instructor_print' && <InstructorGuideView />}
                    {view === 'admin' && <AdminDashboard />}
                    {view === 'detail' && selectedPolicy && <div className="p-8 max-w-4xl mx-auto bg-white min-h-screen"><button onClick={()=>setView('home')} className="mb-6 text-gray-500 hover:text-njra-500 font-bold flex items-center"><i className="fas fa-arrow-left mr-2"></i> Back to Library</button><div className="bg-gray-50 px-3 py-1 rounded inline-block text-xs font-mono mb-2 text-gray-500">CODE: {selectedPolicy.code}</div><h1 className="text-4xl font-extrabold text-njra-500 leading-tight">{selectedPolicy.title}</h1><div className="policy-content mt-8" dangerouslySetInnerHTML={{__html: selectedPolicy.content}}></div></div>}
                    {view === 'quiz' && selectedPolicy && <div className="p-8 max-w-3xl mx-auto bg-white min-h-screen"><button onClick={()=>setView('home')} className="mb-6 text-gray-500 hover:text-njra-500 font-bold flex items-center"><i className="fas fa-arrow-left mr-2"></i> Cancel Quiz</button><h1 className="text-3xl font-bold mb-1">Competency Evaluation</h1><p className="text-gray-500 mb-8 text-lg">for {selectedPolicy.title}</p><QuizComponent policy={selectedPolicy} /></div>}

                    {showAdminLogin && (
                        <div className="fixed inset-0 bg-njra-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-100 transform transition-all scale-100">
                                <div className="text-center mb-6"><div className="inline-block p-3 bg-red-50 rounded-full text-njra-500 mb-2"><i className="fas fa-user-shield text-2xl"></i></div><h3 className="font-bold text-xl text-gray-900">Admin Access</h3></div>
                                <form onSubmit={(e)=>{e.preventDefault(); if(adminPass==="NJRA2025"){setIsAdmin(true); setShowAdminLogin(false); setView('admin');}else{alert("Wrong Code");}}}>
                                    <input type="password" placeholder="Enter Access Code" className="w-full border border-gray-300 p-3 mb-6 rounded-lg outline-none focus:ring-2 focus:ring-njra-500" value={adminPass} onChange={e=>setAdminPass(e.target.value)}/>
                                    <div className="flex gap-3"><button type="button" onClick={()=>setShowAdminLogin(false)} className="njra-btn njra-btn-outline flex-1 py-3">Cancel</button><button type="submit" className="njra-btn njra-btn-primary flex-1 py-3 shadow-lg">Login</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('njra-app-root'));
        root.render(<App />);
    </script>
</body>
</html>
